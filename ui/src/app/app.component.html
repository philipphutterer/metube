<nav class="navbar navbar-expand-md navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">MeTube</a>
    <!--
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsDefault" aria-controls="navbarsDefault" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarsDefault">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
          <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
        </li>
      </ul>
    </div>
    -->
    <div class="ms-auto">
      <button class="btn btn-outline-light button-toggle-theme" aria-label="Toggle theme" (click)="themeChanged()">
        <fa-icon [icon]="darkMode ? faSun : faMoon"></fa-icon>
      </button>
    </div>
  </div>
</nav>

<main role="main" class="container container-xl">
  <form #f="ngForm">
    <div class="container add-url-box">
      <div class="row">
        <div class="col add-url-component input-group">
          <input [(ngModel)]="addUrl"
                 [disabled]="addInProgress || downloads.loading"
                 autocomplete="off"
                 class="form-control"
                 name="addUrl"
                 placeholder="Video or playlist URL"
                 spellcheck="false"
                 type="text">
        </div>
      </div>
      <div class="row">
        <div class="col-md-5 add-url-component">
          <div class="input-group">
            <span class="input-group-text">Quality</span>
            <select (change)="qualityChanged()"
                    [(ngModel)]="selectedQualityId"
                    [disabled]="addInProgress || downloads.loading"
                    class="form-select"
                    name="quality">
              <option *ngFor="let q of selectedFormat.qualities" [ngValue]="q.id">{{ q.text }}</option>
            </select>
          </div>
        </div>
        <div class="col-md-4 add-url-component">
          <div class="input-group">
            <span class="input-group-text">Format</span>
            <select (change)="formatChanged()"
                    [(ngModel)]="selectedFormat"
                    [disabled]="addInProgress || downloads.loading"
                    class="form-select"
                    name="format">
              <option *ngFor="let f of formats" [ngValue]="f">{{ f.text }}</option>
            </select>
          </div>
        </div>
        <div class="col-md-3 add-url-component">
          <div #advancedDropdown="ngbDropdown"
               [attr.class]="showAdvanced() ? 'btn-group add-url-group' : 'add-url-group'"
               display="dynamic"
               ngbDropdown
               placement="bottom-end">
            <button (click)="addCurrentDownload()"
                    [disabled]="addInProgress || downloads.loading"
                    class="btn btn-primary add-url"
                    type="submit">
              <span *ngIf="addInProgress"
                    class="spinner-border spinner-border-sm"
                    id="add-spinner"
                    role="status"></span>
              {{ addInProgress ? "Adding..." : "Add" }}
            </button>
            <button class="btn btn-primary dropdown-toggle dropdown-toggle-split" id="advancedButton" type="button"
                    title="Advanced options" [disabled]="addInProgress || downloads.loading" ngbDropdownAnchor
                    (click)="advancedDropdown.open()" *ngIf="showAdvanced()">
              <span class="sr-only">Advanced options</span>
            </button>
            <div ngbDropdownMenu aria-labelledby="advancedButton"
                 class="dropdown-menu dropdown-menu-end folder-dropdown-menu">
              <div class="container">
                <div class="input-group add-url-component">
                  <span class="input-group-text">Download Folder</span>
                  <ng-select [(ngModel)]="folder"
                             [addTag]="allowCustomDir.bind(this)"
                             [disabled]="addInProgress || downloads.loading"
                             [items]="customDirs$ | async"
                             style="flex-grow: 1;"
                             addTagText="Create directory"
                             bindLabel="folder"
                             placeholder="Default"></ng-select>
                </div>
                <div class="input-group add-url-component">
                  <span class="input-group-text">Custom Name Prefix</span>
                  <input [(ngModel)]="customNamePrefix"
                         [disabled]="addInProgress || downloads.loading"
                         autocomplete="off"
                         class="form-control"
                         name="customNamePrefix"
                         placeholder="Default"
                         spellcheck="false"
                         type="text">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>

  <div *ngIf="downloads.loading" class="alert alert-info" role="alert">
    Connecting to server...
  </div>
  <div class="metube-section-header">Downloading</div>
  <table class="table">
    <thead>
    <tr>
      <th scope="col" style="width: 1rem;">
        <app-parent-checkbox #queueParentCheckbox
                             (changed)="queueSelectionChanged($event)"
                             [list]="downloads.queue"
                             id="queue"></app-parent-checkbox>
      </th>
      <th scope="col">
        <button #queueDelSelected
                (click)="delSelectedDownloads('queue')"
                class="btn btn-link text-decoration-none px-0 me-4"
                disabled
                type="button">
          <fa-icon [icon]="faBan"></fa-icon>&nbsp; Cancel selected
        </button>
      </th>
      <th scope="col" style="width: 14rem;"></th>
      <th scope="col" style="width: 8rem;">Speed</th>
      <th scope="col" style="width: 7rem;">ETA</th>
      <th scope="col" style="width: 2rem;"></th>
      <th scope="col" style="width: 2rem;"></th>
    </tr>
    </thead>
    <tbody>
    <tr *ngFor="let download of downloads.queue | keyvalue: asIsOrder" [class.disabled]='download.value.deleting'>
      <td>
        <app-child-checkbox [id]="download.key" [parent]="queueParentCheckbox"
                            [checkable]="download.value"></app-child-checkbox>
      </td>
      <td title="{{ download.value.filename }}">{{ download.value.title }}</td>
      <td>
        <ngb-progressbar [animated]="download.value.status == 'preparing'"
                         [showValue]="download.value.status != 'preparing'"
                         [striped]="download.value.status == 'preparing'"
                         [value]="download.value.status == 'preparing' ? 100 : download.value.percent"
                         height="1.5rem"
                         type="success"></ngb-progressbar>
      </td>
      <td>{{ download.value.speed | speed }}</td>
      <td>{{ download.value.eta | eta }}</td>
      <td>
        <button type="button" class="btn btn-link" (click)="delDownload('queue', download.key)">
          <fa-icon [icon]="faBan"></fa-icon>
        </button>
      </td>
      <td><a href="{{download.value.url}}" target="_blank">
        <fa-icon [icon]="faExternalLinkAlt"></fa-icon>
      </a></td>
    </tr>
    </tbody>
  </table>

  <div class="metube-section-header">Completed</div>
  <table class="table">
    <thead>
    <tr>
      <th scope="col" style="width: 1rem;">
        <app-parent-checkbox #doneParentCheckbox id="done" [list]="downloads.done"
                             (changed)="doneSelectionChanged($event)"></app-parent-checkbox>
      </th>
      <th scope="col">
        <button type="button" class="btn btn-link text-decoration-none px-0 me-4" disabled #doneDelSelected
                (click)="delSelectedDownloads('done')">
          <fa-icon [icon]="faTrashAlt"></fa-icon>&nbsp; Clear selected
        </button>
        <button type="button" class="btn btn-link text-decoration-none px-0 me-4" disabled #doneClearCompleted
                (click)="clearCompletedDownloads()">
          <fa-icon [icon]="faCheckCircle"></fa-icon>&nbsp; Clear completed
        </button>
        <button type="button" class="btn btn-link text-decoration-none px-0 me-4" disabled #doneClearFailed
                (click)="clearFailedDownloads()">
          <fa-icon [icon]="faTimesCircle"></fa-icon>&nbsp; Clear failed
        </button>
      </th>
      <th scope="col" style="width: 2rem;"></th>
      <th scope="col" style="width: 2rem;"></th>
      <th scope="col" style="width: 2rem;"></th>
      <th scope="col" style="width: 2rem;"></th>
    </tr>
    </thead>
    <tbody>
    <tr *ngFor="let download of downloads.done | keyvalue: asIsOrder" [class.disabled]='download.value.deleting'>
      <td>
        <app-child-checkbox [id]="download.key" [parent]="doneParentCheckbox"
                            [checkable]="download.value"></app-child-checkbox>
      </td>
      <td>
        <div style="display: inline-block; width: 1.5rem;">
          <fa-icon *ngIf="download.value.status == 'finished'" [icon]="faCheckCircle" style="color: green;"></fa-icon>
          <fa-icon *ngIf="download.value.status == 'error'" [icon]="faTimesCircle" style="color: red;"></fa-icon>
        </div>
        <span ngbTooltip="{{download.value.msg}}">
          <a *ngIf="!!download.value.filename; else noDownloadLink"
             href="{{buildDownloadLink(download.value)}}"
             target="_blank">{{ download.value.title }}</a>
        </span>
        <ng-template #noDownloadLink>{{ download.value.title }}</ng-template>
      </td>
      <td>
        <button *ngIf="download.value.status == 'error'" type="button" class="btn btn-link"
                (click)="retryDownload(download.key, download.value)">
          <fa-icon [icon]="faRedoAlt"></fa-icon>
        </button>
      </td>
      <td>
        <a *ngIf="!!download.value.filename; else noDownloadLink" href="{{buildDownloadLink(download.value)}}" download>
          <fa-icon [icon]="faDownload"></fa-icon>
        </a>
      </td>
      <td>
        <a href="{{download.value.url}}" target="_blank">
          <fa-icon [icon]="faExternalLinkAlt"></fa-icon>
        </a>
      </td>
      <td>
        <button type="button" class="btn btn-link" (click)="delDownload('done', download.key)">
          <fa-icon [icon]="faTrashAlt"></fa-icon>
        </button>
      </td>
    </tr>
    </tbody>
  </table>

</main><!-- /.container -->
